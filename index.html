<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DOIT Tramas</title>
<!-- Se incorporan los iconos de Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary-color: #2e7eff;
  --primary-light: rgba(46, 126, 255, 0.15);
  --primary-dark: #1a5fc4;
  --primary-hover: #4a90ff;
  --text-color: #f0f0f0;
  --text-secondary: #a0a0a0;
  --bg-color: #121212;
  --card-bg: #1e1e1e;
  --card-hover: #252525;
  --input-bg: #2a2a2a;
  --border-color: #333;
  --border-focus: #4a90ff;
  --success-color: #2ecc71;
  --danger-color: #e74c3c;
  --warning-color: #f39c12;
  --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
  --shadow-md: 0 4px 8px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 16px rgba(0,0,0,0.4);
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --transition-fast: 0.2s ease;
  --transition-normal: 0.3s ease;
  --generate-btn-color: #2ecc71; /* Green color for generate button */
  --generate-btn-hover: #27ae60; /* Darker green for hover state */
}

/* Variables para tema claro */
.light-theme {
  --primary-color: #1a73e8;
  --primary-light: rgba(26, 115, 232, 0.15);
  --primary-dark: #0d47a1;
  --primary-hover: #4285f4;
  --text-color: #333333;
  --text-secondary: #666666;
  --bg-color: #f5f5f5;
  --card-bg: #ffffff;
  --card-hover: #f9f9f9;
  --input-bg: #f0f0f0;
  --border-color: #dddddd;
  --border-focus: #4285f4;
  --generate-btn-color: #2ecc71; /* Green color for generate button */
  --generate-btn-hover: #27ae60; /* Darker green for hover state */
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
  background-color: var(--bg-color);
  color: var(--text-color);
  font-family: var(--font-family);
  line-height: 1.6;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  transition: background-color var(--transition-normal), color var(--transition-normal);
}
.container {
  max-width: 1000px;
  width: 100%;
  margin: 0 auto;
  padding: 20px;
  flex: 1;
}
header {
  text-align: center;
  margin-bottom: 30px;
  padding: 30px 0;
  border-bottom: 1px solid var(--border-color);
  background: linear-gradient(to right, rgba(46, 126, 255, 0.05), rgba(46, 126, 255, 0.1), rgba(46, 126, 255, 0.05));
  position: relative;
  overflow: hidden;
  transition: background var(--transition-normal), border-color var(--transition-normal);
}
header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(to right, transparent, var(--primary-color), transparent);
}
h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
  color: var(--primary-color);
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  transition: color var(--transition-normal);
}
h1 i {
  font-size: 2rem;
}
.subtitle {
  font-size: 1.2rem;
  color: var(--text-secondary);
  font-weight: 300;
  transition: color var(--transition-normal);
}
.card {
  background-color: var(--card-bg);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-md);
  margin-bottom: 30px;
  overflow: hidden;
  transition: transform var(--transition-normal), box-shadow var(--transition-normal), background-color var(--transition-normal);
  border: 1px solid rgba(255,255,255,0.05);
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}
.card-header {
  background-color: var(--primary-light);
  padding: 18px 24px;
  border-bottom: 1px solid var(--border-color);
  position: relative;
  transition: background-color var(--transition-normal), border-color var(--transition-normal);
}
.card-header::after {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background-color: var(--primary-color);
  transition: background-color var(--transition-normal);
}
.card-header h2 {
  margin: 0;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 12px;
}
.card-header h2 i {
  color: var(--primary-color);
  font-size: 1.3rem;
  transition: color var(--transition-normal);
}
.card-body {
  padding: 24px;
}
.form-group {
  margin-bottom: 24px;
  position: relative;
}
.form-row {
  display: flex;
  gap: 20px;
  margin-bottom: 24px;
}
.col {
  flex: 1;
}
label {
  display: block;
  margin-bottom: 10px;
  font-weight: 500;
  font-size: 1rem;
  color: var(--text-secondary);
  transition: color var(--transition-fast);
}
label i {
  margin-right: 8px;
  width: 16px;
  text-align: center;
  color: var(--primary-color);
  transition: color var(--transition-normal);
}
.form-group:focus-within label {
  color: var(--primary-color);
}
input, select {
  width: 100%;
  padding: 12px 16px;
  background-color: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  color: var(--text-color);
  font-size: 1rem;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background-color var(--transition-fast), color var(--transition-normal);
}
input:hover, select:hover {
  background-color: rgba(42, 42, 42, 0.8);
}
.light-theme input:hover, .light-theme select:hover {
  background-color: rgba(240, 240, 240, 0.8);
}
input:focus, select:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px rgba(46,126,255,0.25);
  background-color: rgba(42, 42, 42, 0.9);
}
.light-theme input:focus, .light-theme select:focus {
  background-color: rgba(240, 240, 240, 0.9);
}
.select-container {
  position: relative;
}
.select-container::after {
  content: "▼";
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
  pointer-events: none;
  font-size: 0.8rem;
  transition: color var(--transition-fast);
}
.select-container:focus-within::after {
  color: var(--primary-color);
}
.hidden {
  display: none;
}
.btn {
  padding: 12px 24px;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: background-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
  text-align: center;
  box-shadow: var(--shadow-sm);
}
.btn i {
  margin-right: 10px;
}
.btn:hover {
  background-color: var(--primary-hover);
  box-shadow: var(--shadow-md);
}
.btn:active {
  transform: translateY(1px);
  box-shadow: var(--shadow-sm);
}
.btn.small {
  padding: 8px 16px;
  font-size: 0.9rem;
}
.btn.primary {
  background-color: var(--generate-btn-color);
}
.btn.primary:hover {
  background-color: var(--generate-btn-hover);
}
.btn.secondary {
  background-color: #555;
}
.btn.secondary:hover {
  background-color: #666;
}
.light-theme .btn.secondary {
  background-color: #aaa;
}
.light-theme .btn.secondary:hover {
  background-color: #999;
}
.action-buttons {
  margin: 24px 0;
  display: flex;
  justify-content: center;
  gap: 16px;
  flex-wrap: wrap;
}
.output {
  background: var(--input-bg);
  padding: 18px;
  border-radius: var(--radius-sm);
  white-space: pre-wrap;
  font-family: 'Courier New', Courier, monospace;
  overflow-x: auto;
  border: 1px solid var(--border-color);
  min-height: 60px;
  transition: border-color var(--transition-fast), background-color var(--transition-normal);
  position: relative;
}
.output:hover {
  border-color: rgba(255,255,255,0.2);
}
.light-theme .output:hover {
  border-color: rgba(0,0,0,0.2);
}
.trama-output {
  margin-top: 24px;
  position: relative;
}
.output-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-weight: 600;
}
.output-header i {
  color: var(--text-color);
  margin-right: 8px;
  transition: color var(--transition-normal);
}
.input-with-button {
  display: flex;
  gap: 12px;
}
.input-with-button input {
  flex: 1;
}
.color-preview {
  width: 50px;
  height: 30px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
  margin-left: 10px;
  transition: transform var(--transition-fast);
}
.color-preview:hover {
  transform: scale(1.05);
}
.color-picker-row {
  align-items: flex-end;
}
.color-input {
  height: 40px;
  padding: 0;
  background: transparent;
  border: none;
  cursor: pointer;
}
input[type="color"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  width: 100%;
  height: 40px;
  background-color: transparent;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-sm);
  padding: 0;
  cursor: pointer;
}
input[type="color"]::-webkit-color-swatch-wrapper {
  padding: 0;
}
input[type="color"]::-webkit-color-swatch {
  border: none;
  border-radius: 3px;
}
input[type="color"]:hover {
  border-color: var(--primary-color);
}
footer {
  text-align: center;
  padding: 24px;
  margin-top: 20px;
  border-top: 1px solid var(--border-color);
  color: var(--text-secondary);
  background: linear-gradient(to right, rgba(46, 126, 255, 0.05), rgba(46, 126, 255, 0.1), rgba(46, 126, 255, 0.05));
  transition: background var(--transition-normal), border-color var(--transition-normal), color var(--transition-normal);
}
.output-container {
  margin-top: 24px;
}
.fade-in {
  animation: fadeIn 0.3s;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.copy-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: var(--success-color);
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-md);
  z-index: 1000;
  animation: toastIn 0.3s ease, fadeOut 2s 0.5s forwards;
  display: flex;
  align-items: center;
  gap: 8px;
}
@keyframes toastIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeOut {
  0% { opacity: 1; }
  80% { opacity: 1; }
  100% { opacity: 0; }
}
@media (max-width: 768px) {
  .form-row {
    flex-direction: column;
    gap: 16px;
  }
  .input-with-button {
    flex-direction: column;
  }
  .card-header h2 {
    font-size: 1.3rem;
  }
  .container {
    padding: 12px;
  }
  .card-body {
    padding: 16px;
  }
}
.decoded-item {
  padding: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  transition: background-color var(--transition-fast);
  border-radius: var(--radius-sm);
}
.light-theme .decoded-item {
  border-bottom: 1px solid rgba(0,0,0,0.1);
}
.decoded-item:hover {
  background-color: rgba(255,255,255,0.05);
}
.light-theme .decoded-item:hover {
  background-color: rgba(0,0,0,0.05);
}
.decoded-item:last-child {
  border-bottom: none;
}
.decoded-item .icon {
  width: 30px;
  margin-right: 12px;
  text-align: center;
  color: var(--primary-color);
  font-size: 1.1rem;
  transition: color var(--transition-normal);
}
.decoded-item .label {
  font-weight: bold;
  margin-right: 12px;
  min-width: 120px;
  color: var(--text-color);
  transition: color var(--transition-normal);
}
.decoded-item .value {
  font-family: 'Courier New', monospace;
  background-color: rgba(0,0,0,0.2);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.1);
  transition: background-color var(--transition-normal), border-color var(--transition-normal);
}
.light-theme .decoded-item .value {
  background-color: rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.1);
}
.decoded-item.checksum.valid {
  color: var(--success-color);
}
.decoded-item.checksum.invalid {
  color: var(--danger-color);
}
.section-divider {
  height: 1px;
  background: linear-gradient(to right, transparent, var(--border-color), transparent);
  margin: 24px 0;
  transition: background var(--transition-normal);
}
.rgb-preview-container {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 12px;
}
.rgb-preview {
  width: 60px;
  height: 40px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
  transition: transform var(--transition-fast), border-color var(--transition-normal);
}
.rgb-preview:hover {
  transform: scale(1.05);
}
.rgb-value {
  font-family: 'Courier New', monospace;
  background-color: rgba(0,0,0,0.2);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.1);
  transition: background-color var(--transition-normal), border-color var(--transition-normal);
}
.light-theme .rgb-value {
  background-color: rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.1);
}
.tooltip {
  position: relative;
  display: inline-block;
}
.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -100px;
  opacity: 0;
  transition: opacity 0.3s;
  box-shadow: var(--shadow-md);
  font-size: 0.9rem;
}
.light-theme .tooltip .tooltiptext {
  background-color: #555;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
.pulse {
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(46, 126, 255, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(46, 126, 255, 0); }
  100% { box-shadow: 0 0 0 0 rgba(46, 126, 255, 0); }
}

/* Nuevos estilos */
.theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 100;
  background-color: var(--card-bg);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
  transition: background-color var(--transition-normal), border-color var(--transition-normal);
}
.theme-toggle i {
  color: var(--primary-color);
  font-size: 1.2rem;
  transition: transform var(--transition-normal), color var(--transition-normal);
}
.theme-toggle:hover i {
  transform: rotate(30deg);
}

.error-message {
  color: var(--danger-color);
  font-size: 0.85rem;
  margin-top: 5px;
  display: none;
}

.history-panel {
  position: fixed;
  right: -300px;
  top: 0;
  width: 300px;
  height: 100%;
  background-color: var(--card-bg);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  transition: right var(--transition-normal);
  overflow-y: auto;
  border-left: 1px solid var(--border-color);
  padding: 20px;
  transition: right var(--transition-normal), background-color var(--transition-normal), border-color var(--transition-normal);
}
.history-panel.open {
  right: 0;
}
.history-toggle {
  position: fixed;
  top: 70px;
  right: 20px;
  z-index: 100;
  background-color: var(--card-bg);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
  transition: background-color var(--transition-normal), border-color var(--transition-normal);
}
.history-toggle i {
  color: var(--primary-color);
  font-size: 1.2rem;
  transition: color var(--transition-normal);
}
.history-item {
  padding: 10px;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
  transition: background-color var(--transition-fast);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
}
.history-item:hover {
  background-color: var(--primary-light);
}
.history-item-title {
  font-weight: bold;
  margin-bottom: 5px;
  color: var(--primary-color);
}
.history-item-content {
  font-family: 'Courier New', monospace;
  font-size: 0.8rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}
.history-header h3 {
  margin: 0;
  color: var(--primary-color);
}
.history-close {
  cursor: pointer;
  color: var(--text-secondary);
  transition: color var(--transition-fast);
}
.history-close:hover {
  color: var(--danger-color);
}
.clear-history {
  background-color: var(--danger-color);
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 0.8rem;
  margin-top: 10px;
  transition: background-color var(--transition-fast);
}
.clear-history:hover {
  background-color: #c0392b;
}

.help-icon {
  margin-left: 8px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: color var(--transition-fast);
}
.help-icon:hover {
  color: var(--primary-color);
}

.frame-structure {
  margin-top: 20px;
  padding: 15px;
  background-color: var(--card-bg);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
  transition: background-color var(--transition-normal), border-color var(--transition-normal);
}
.frame-structure-title {
  font-weight: bold;
  margin-bottom: 10px;
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 8px;
  transition: color var(--transition-normal);
}
.frame-byte {
  display: inline-block;
  padding: 5px 8px;
  margin: 3px;
  background-color: var(--input-bg);
  border-radius: var(--radius-sm);
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
  border: 1px solid var(--border-color);
  position: relative;
  transition: background-color var(--transition-normal), border-color var(--transition-normal);
}
.frame-byte:hover .byte-tooltip {
  visibility: visible;
  opacity: 1;
}
.byte-tooltip {
  visibility: hidden;
  width: 150px;
  background-color: #333;
  color: white;
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -75px;
  opacity: 0;
  transition: opacity 0.3s;
  font-size: 0.8rem;
}
.light-theme .byte-tooltip {
  background-color: #555;
}
.byte-tooltip::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #333 transparent transparent transparent;
}
.light-theme .byte-tooltip::after {
  border-color: #555 transparent transparent transparent;
}

.validation-error {
  border-color: var(--danger-color) !important;
}

.save-config-panel {
  margin-top: 20px;
  padding: 15px;
  background-color: var(--card-bg);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-color);
  transition: background-color var(--transition-normal), border-color var(--transition-normal);
}
.saved-configs {
  margin-top: 10px;
}
.config-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px;
  border-bottom: 1px solid var(--border-color);
  transition: background-color var(--transition-fast);
}
.config-item:hover {
  background-color: var(--primary-light);
}
.config-name {
  font-weight: bold;
}
.config-actions {
  display: flex;
  gap: 8px;
}
.config-action {
  cursor: pointer;
  color: var(--text-secondary);
  transition: color var(--transition-fast);
}
.config-action:hover {
  color: var(--primary-color);
}
.config-action.delete:hover {
  color: var(--danger-color);
}

/* Estilo para múltiples destinos */
.destinos-container {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.destino-tag {
  background-color: var(--primary-light);
  color: var(--text-color);
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
}
.destino-tag i {
  cursor: pointer;
  color: var(--text-secondary);
  transition: color var(--transition-fast);
}
.destino-tag i:hover {
  color: var(--danger-color);
}
</style>
</head>
<body onload="inicializarApp()">
<!-- Botón de cambio de tema -->
<div class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
  <i class="fas fa-moon"></i>
</div>

<!-- Botón de historial -->
<div class="history-toggle" onclick="toggleHistory()" title="Historial de tramas">
  <i class="fas fa-history"></i>
</div>

<!-- Panel de historial -->
<div class="history-panel" id="historyPanel">
  <div class="history-header">
    <h3>Historial de Tramas</h3>
    <div class="history-close" onclick="toggleHistory()"><i class="fas fa-times"></i></div>
  </div>
  <div id="historyItems">
    <!-- Los items del historial se generarán dinámicamente -->
  </div>
  <button class="clear-history" onclick="clearHistory()">Limpiar historial</button>
</div>

<div class="container">
  <header>
    <h1><i class="fas fa-microchip"></i> DOIT Tramas</h1>
    <p class="subtitle">Generador y Decodificador de Tramas</p>
  </header>

  <!-- GENERADOR DE TRAMAS -->
  <div class="card">
    <div class="card-header">
      <h2><i class="fas fa-code"></i> Generador de Tramas</h2>
    </div>
    <div class="card-body">
      <!-- Origen y destino -->
      <div class="form-group">
        <label for="origen">
          <i class="fas fa-broadcast-tower"></i> Origen:
          <i class="fas fa-question-circle help-icon" title="Dispositivo que envía la trama"></i>
        </label>
        <div class="select-container">
          <select id="origen" onchange="toggleOrigenInput(); actualizarEstructuraTrama()">
            <option value="DB">BOTONERA (0xDB)</option>
            <option value="DC">CONSOLA (0xDC)</option>
            <option value="DD">DEFAULT_DEVICE (0xDD)</option>
            <option value="FF">BROADCAST (0xFF)</option>
            <option value="custom">Otro...</option>
          </select>
        </div>
        <input id="origenCustom" placeholder="Ej: A5" class="hidden" oninput="actualizarEstructuraTrama()">
        <div id="origenError" class="error-message">Ingrese un valor hexadecimal válido (00-FF)</div>
      </div>
      <div class="form-group">
        <label for="destino">
          <i class="fas fa-laptop-code"></i> Destino(s):
          <i class="fas fa-question-circle help-icon" title="Dispositivos que recibirán la trama"></i>
        </label>
        <div class="select-container">
          <select id="destino" onchange="toggleDestinoInput(); actualizarEstructuraTrama()">
            <option value="DD">DEFAULT_DEVICE (0xDD)</option>
            <option value="DB">BOTONERA (0xDB)</option>
            <option value="DC">CONSOLA (0xDC)</option>
            <option value="FF">BROADCAST (0xFF)</option>
            <option value="manual">Entrada manual...</option>
          </select>
        </div>
        <input id="destinoManual" placeholder="Ej: FF o FF DB DC (separados por espacios)" class="hidden" oninput="actualizarEstructuraTrama()">
        <div id="destinoError" class="error-message">Ingrese valores hexadecimales válidos (00-FF) separados por espacios</div>
      </div>
      
      <!-- Función -->
      <div class="form-group">
        <label for="function">
          <i class="fas fa-cogs"></i> Función:
          <i class="fas fa-question-circle help-icon" title="Tipo de operación que realizará la trama"></i>
        </label>
        <div class="select-container">
          <select id="function" onchange="actualizarVistaDatos()">
            <option value="C1">F_SEND_COLOR</option>
            <option value="C2">F_SEND_RGB</option>
            <option value="CE">F_SEND_FLAG_BYTE</option>
            <option value="CA">F_SEND_SENSOR_VALUE</option>
            <option value="CF">F_SEND_COMMAND</option>
            <option value="A0">F_REQ_ELEM_SECTOR</option>
            <option value="B1">F_SET_ELEM_ID</option>
            <option value="B2">F_SET_ELEM_MODE</option>
            <option value="B3">F_SET_ELEM_DEAF</option>
            <option value="CC">F_SEND_FILE_NUM</option>
            <option value="CD">F_SEND_PATTERN_NUM</option>
          </select>
        </div>
      </div>
      
      <div class="section-divider"></div>
      
      <!-- Paneles específicos para cada función -->
      <div id="sectorSelector" class="form-group hidden">
        <label for="sector"><i class="fas fa-folder-open"></i> Sector:</label>
        <div class="select-container">
          <select id="sector" onchange="actualizarEstructuraTrama()"></select>
        </div>
      </div>
      <div id="idiomaSelector" class="form-group hidden">
        <label for="idioma"><i class="fas fa-language"></i> Idioma:</label>
        <div class="select-container">
          <select id="idioma" onchange="actualizarEstructuraTrama()">
            <option value="1">ES</option>
            <option value="2">EN</option>
            <option value="3">DE</option>
            <option value="4">FR</option>
            <option value="5">ES_MX</option>
            <option value="6">CA</option>
            <option value="7">EU</option>
            <option value="8">X</option>
            <option value="9">X1</option>
          </select>
        </div>
      </div>
      <div id="colorSelector" class="form-group hidden">
        <label for="color"><i class="fas fa-palette"></i> Color:</label>
        <div class="select-container">
          <select id="color" onchange="actualizarEstructuraTrama()"></select>
        </div>
      </div>
      <div id="rgbSelector" class="form-group hidden">
        <div class="form-row">
          <div class="form-group col">
            <label for="rVal"><i class="fas fa-circle" style="color: red;"></i> R:</label>
            <input id="rVal" placeholder="0-255 o 0xFF" type="text" oninput="validateHexOrDecimal(this, 0, 255); actualizarEstructuraTrama()">
            <div id="rValError" class="error-message">Valor debe estar entre 0-255</div>
          </div>
          <div class="form-group col">
            <label for="gVal"><i class="fas fa-circle" style="color: green;"></i> G:</label>
            <input id="gVal" placeholder="0-255 o 0xFF" type="text" oninput="validateHexOrDecimal(this, 0, 255); actualizarEstructuraTrama()">
            <div id="gValError" class="error-message">Valor debe estar entre 0-255</div>
          </div>
          <div class="form-group col">
            <label for="bVal"><i class="fas fa-circle" style="color: blue;"></i> B:</label>
            <input id="bVal" placeholder="0-255 o 0xFF" type="text" oninput="validateHexOrDecimal(this, 0, 255); actualizarEstructuraTrama()">
            <div id="bValError" class="error-message">Valor debe estar entre 0-255</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col">
            <label for="rgbPicker"><i class="fas fa-eye-dropper"></i> Selector de color:</label>
            <input type="color" id="rgbPicker" class="color-input">
          </div>
          <div class="form-group col">
            <div class="rgb-preview-container">
              <div id="colorPreview" class="rgb-preview"></div>
              <span class="rgb-value" id="rgbValue">RGB(0, 0, 0)</span>
            </div>
          </div>
        </div>
      </div>
      <div id="flagSelector" class="form-group hidden">
        <label for="flag"><i class="fas fa-toggle-on"></i> Estado:</label>
        <div class="select-container">
          <select id="flag" onchange="actualizarEstructuraTrama()">
            <option value="01">ON</option>
            <option value="00">OFF</option>
          </select>
        </div>
      </div>
      <div id="sensorSelector" class="form-group hidden">
        <div class="form-row">
          <div class="form-group col">
            <label for="minVal"><i class="fas fa-temperature-low"></i> Valor mínimo:</label>
            <input id="minVal" type="number" oninput="validateNumber(this); actualizarEstructuraTrama()">
            <div id="minValError" class="error-message">Ingrese un número válido</div>
          </div>
          <div class="form-group col">
            <label for="maxVal"><i class="fas fa-temperature-high"></i> Valor máximo:</label>
            <input id="maxVal" type="number" oninput="validateNumber(this); actualizarEstructuraTrama()">
            <div id="maxValError" class="error-message">Ingrese un número válido</div>
          </div>
        </div>
        <div class="form-group">
          <label for="valVal"><i class="fas fa-thermometer-half"></i> Valor actual:</label>
          <input id="valVal" type="number" oninput="validateNumber(this); actualizarEstructuraTrama()">
          <div id="valValError" class="error-message">Ingrese un número válido</div>
        </div>
      </div>
      <div id="commandSelector" class="form-group hidden">
        <label for="commandSel"><i class="fas fa-terminal"></i> Comando:</label>
        <div class="select-container">
          <select id="commandSel" onchange="actualizarEstructuraTrama()"></select>
        </div>
      </div>
      <!-- Nuevos paneles para funciones adicionales -->
      <div id="elemIdSelector" class="form-group hidden">
        <label for="elemId"><i class="fas fa-id-card"></i> ID Elemento (0x00 a 0xFF):</label>
        <input id="elemId" placeholder="Ej: 0x00" type="text" oninput="validateHexOrDecimal(this, 0, 255); actualizarEstructuraTrama()">
        <div id="elemIdError" class="error-message">Valor debe estar entre 0x00 y 0xFF</div>
      </div>
      <div id="elemModeSelector" class="form-group hidden">
        <label for="elemMode"><i class="fas fa-sliders-h"></i> Modo Elemento (0x00 a 0x0F):</label>
        <input id="elemMode" placeholder="Ej: 0x00" type="text" oninput="validateHexOrDecimal(this, 0, 15); actualizarEstructuraTrama()">
        <div id="elemModeError" class="error-message">Valor debe estar entre 0x00 y 0x0F</div>
      </div>
      <div id="elemDeafSelector" class="form-group hidden">
        <label for="elemDeaf"><i class="fas fa-volume-mute"></i> Tiempo Ensordecer (0x00 a 0xFF):</label>
        <input id="elemDeaf" placeholder="Ej: 0x00" type="text" oninput="validateHexOrDecimal(this, 0, 255); actualizarEstructuraTrama()">
        <div id="elemDeafError" class="error-message">Valor debe estar entre 0x00 y 0xFF</div>
      </div>
      <div id="fileNumSelector" class="form-group hidden">
        <label><i class="fas fa-file-alt"></i> Número de Archivo:</label>
        <div class="form-row">
          <div class="form-group col">
            <label for="fileBank"><i class="fas fa-university"></i> Bank:</label>
            <input id="fileBank" placeholder="Ej: 0x00" type="text" oninput="validateHexOrDecimal(this, 0, 255); actualizarEstructuraTrama()">
            <div id="fileBankError" class="error-message">Valor debe estar entre 0x00 y 0xFF</div>
          </div>
          <div class="form-group col">
            <label for="fileNum"><i class="fas fa-hashtag"></i> File:</label>
            <input id="fileNum" placeholder="Ej: 0x00" type="text" oninput="validateHexOrDecimal(this, 0, 255); actualizarEstructuraTrama()">
            <div id="fileNumError" class="error-message">Valor debe estar entre 0x00 y 0xFF</div>
          </div>
        </div>
      </div>
      <div id="patternNumSelector" class="form-group hidden">
        <label for="patternNum"><i class="fas fa-th"></i> Número de Patrón (0x00 a 0xFF):</label>
        <input id="patternNum" placeholder="Ej: 0x00" type="text" oninput="validateHexOrDecimal(this, 0, 255); actualizarEstructuraTrama()">
        <div id="patternNumError" class="error-message">Valor debe estar entre 0x00 y 0xFF</div>
      </div>
      <!-- Si la función seleccionada no es de las especializadas, se muestra el campo de Datos -->
      <div id="dataInput" class="form-group hidden">
        <label for="data"><i class="fas fa-cubes"></i> Datos (hex separados por espacio):</label>
        <input id="data" placeholder="Ej: 03 o 01 FF" oninput="actualizarEstructuraTrama()">
        <div id="dataError" class="error-message">Ingrese valores hexadecimales válidos separados por espacios</div>
      </div>
      
      <!-- Visualización de la estructura de la trama -->
      <div class="frame-structure">
        <div class="frame-structure-title">
          <i class="fas fa-sitemap"></i> Estructura de la Trama
        </div>
        <div id="frameStructure">
          <div class="frame-byte">0xE1<div class="byte-tooltip">Inicio de trama</div></div>
          <div class="frame-byte">0x00<div class="byte-tooltip">Longitud (MSB)</div></div>
          <div class="frame-byte">0x00<div class="byte-tooltip">Longitud (LSB)</div></div>
          <div class="frame-byte">0xDB<div class="byte-tooltip">Origen</div></div>
          <div class="frame-byte">0x01<div class="byte-tooltip">Número de destinos</div></div>
          <div class="frame-byte">0xDD<div class="byte-tooltip">Destino</div></div>
          <div class="frame-byte">0xC1<div class="byte-tooltip">Función</div></div>
          <div class="frame-byte">0x00<div class="byte-tooltip">Longitud datos (MSB)</div></div>
          <div class="frame-byte">0x01<div class="byte-tooltip">Longitud datos (LSB)</div></div>
          <div class="frame-byte">0x00<div class="byte-tooltip">Datos</div></div>
          <div class="frame-byte">0x24<div class="byte-tooltip">Checksum</div></div>
          <div class="frame-byte">0xBB<div class="byte-tooltip">Fin de trama</div></div>
        </div>
      </div>
      
      <!-- Guardar configuración -->
      <div class="save-config-panel">
        <div class="form-group">
          <label for="configName"><i class="fas fa-save"></i> Guardar configuración actual:</label>
          <div class="input-with-button">
            <input id="configName" placeholder="Nombre de la configuración">
            <button class="btn small" onclick="saveCurrentConfig()">
              <i class="fas fa-save"></i> Guardar
            </button>
          </div>
        </div>
        <div class="saved-configs" id="savedConfigs">
          <!-- Las configuraciones guardadas se mostrarán aquí -->
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="btn primary pulse" onclick="generarTrama()">
          <i class="fas fa-hammer"></i> Generar Trama
        </button>
        <button class="btn secondary" onclick="limpiarFormulario()">
          <i class="fas fa-eraser"></i> Limpiar
        </button>
      </div>
      <div class="trama-output">
        <div class="output-header">
          <span><i class="fas fa-code"></i> Trama Generada:</span>
          <div>
            <button class="btn small" onclick="copiarTrama()" id="copyBtn">
              <i class="fas fa-copy"></i> Copiar
            </button>
            <button class="btn small" onclick="guardarEnHistorial()" id="saveHistoryBtn">
              <i class="fas fa-bookmark"></i> Guardar
            </button>
          </div>
        </div>
        <div class="output" id="tramaHex"></div>
      </div>
    </div>
  </div>
  
  <!-- DECODIFICADOR DE TRAMAS -->
  <div class="card">
    <div class="card-header">
      <h2><i class="fas fa-microscope"></i> Decodificador de Tramas</h2>
    </div>
    <div class="card-body">
      <div class="form-group">
        <label for="inputTrama"><i class="fas fa-paste"></i> Trama a decodificar:</label>
        <div class="input-with-button">
          <input id="inputTrama" placeholder="Ej: 0xE1 0x00 0x09 0xDB 0x01 0xDD 0xC1 0x00 0x01 0x00 0x24 0xBB">
        </div>
        <div id="inputTramaError" class="error-message">Formato de trama inválido</div>
      </div>
      <div class="action-buttons">
        <button class="btn primary" onclick="decodificarTrama()">
          <i class="fas fa-search"></i> Decodificar Trama
        </button>
      </div>
      <div class="output-container">
        <div class="output-header">
          <span><i class="fas fa-info-circle"></i> Resultado:</span>
        </div>
        <div class="output" id="resultado"></div>
      </div>
    </div>
  </div>
</div>

<footer>
  <p>DOIT Tramas &copy; 2025</p>
</footer>

<script>
  // Mapeo de dispositivos
  const deviceMap = {
    "DB": "BOTONERA",
    "DC": "CONSOLA",
    "DD": "DEFAULT_DEVICE",
    "FF": "BROADCAST"
  };
  
  // Mapeo de funciones
  const functionMap = {
    "C1": "F_SEND_COLOR",
    "C2": "F_SEND_RGB",
    "CE": "F_SEND_FLAG_BYTE",
    "CA": "F_SEND_SENSOR_VALUE",
    "CF": "F_SEND_COMMAND",
    "A0": "F_REQ_ELEM_SECTOR",
    "B1": "F_SET_ELEM_ID",
    "B2": "F_SET_ELEM_MODE",
    "B3": "F_SET_ELEM_DEAF",
    "CC": "F_SEND_FILE_NUM",
    "CD": "F_SEND_PATTERN_NUM"
  };
  
  // Función que permite interpretar valores en decimal o hexadecimal
  function parseColorValue(val) {
    val = val.trim();
    if(val.startsWith("0x") || val.startsWith("0X")) {
      return parseInt(val, 16);
    }
    if(!/^\d+$/.test(val) && /^[0-9A-Fa-f]+$/.test(val)) {
      return parseInt(val, 16);
    }
    return parseInt(val, 10) || 0;
  }
  
  /* Tablas de mapeo */
  const colorMap = {
    0x00:"BLANCO",0x01:"AMARILLO",0x02:"NARANJA",0x03:"ROJO",0x04:"VIOLETA",0x05:"AZUL",
    0x06:"CELESTE",0x07:"VERDE",0x08:"NEGRO",0x09:"RELAY",0x0F:"CREMA",0x1F:"ROSA",
    0x1E:"LILA",0x1B:"CELESTE CLARO",0x19:"TURQUESA",0x10:"VERDE CLARO",0x20:"ROSA OSCURO",
    0x12:"VERDE OLIVA",0x14:"VERDE LIMA",0x0E:"VERDE AMARILLO",0x22:"MAGENTA",0x1D:"MORADO",
    0x17:"VERDE AZULADO",0x0B:"MARRÓN",0x1C:"ÍNDIGO",0x18:"AZUL VERDOSO",0x16:"ESMERALDA",
    0x1A:"CYAN",0x15:"VERDE MENTA",0x0D:"AMARILLO ANARANJADO",0x21:"ROSA FUERTE",
    0x0A:"MARRÓN OSCURO",0x13:"VERDE GRISACEO",0x11:"VERDE OLIVA CLARO",0x23:"SALMÓN"
  };
  
  const idiomaMap = {
    1:"ES", 2:"EN", 3:"DE", 4:"FR", 5:"ES_MX", 6:"CA", 7:"EU", 8:"X", 9:"X1"
  };
  
  const sectorList = {
    0:"ELEM_NAME_SECTOR",1:"ELEM_DESC_SECTOR",2:"ELEM_SERIAL_SECTOR",3:"ELEM_ID_SECTOR",4:"ELEM_CMODE_SECTOR",
    5:"ELEM_MODE_0_NAME_SECTOR",6:"ELEM_MODE_0_DESC_SECTOR",7:"ELEM_MODE_0_FLAG_SECTOR",8:"ELEM_MODE_1_NAME_SECTOR",
    9:"ELEM_MODE_1_DESC_SECTOR",10:"ELEM_MODE_1_FLAG_SECTOR",11:"ELEM_MODE_2_NAME_SECTOR",12:"ELEM_MODE_2_DESC_SECTOR",
    13:"ELEM_MODE_2_FLAG_SECTOR",14:"ELEM_MODE_3_NAME_SECTOR",15:"ELEM_MODE_3_DESC_SECTOR",16:"ELEM_MODE_3_FLAG_SECTOR",
    17:"ELEM_MODE_4_NAME_SECTOR",18:"ELEM_MODE_4_DESC_SECTOR",19:"ELEM_MODE_4_FLAG_SECTOR",20:"ELEM_MODE_5_NAME_SECTOR",
    21:"ELEM_MODE_5_DESC_SECTOR",22:"ELEM_MODE_5_FLAG_SECTOR",23:"ELEM_MODE_6_NAME_SECTOR",24:"ELEM_MODE_6_DESC_SECTOR",
    25:"ELEM_MODE_6_FLAG_SECTOR",26:"ELEM_MODE_7_NAME_SECTOR",27:"ELEM_MODE_7_DESC_SECTOR",28:"ELEM_MODE_7_FLAG_SECTOR",
    29:"ELEM_MODE_8_NAME_SECTOR",30:"ELEM_MODE_8_DESC_SECTOR",31:"ELEM_MODE_8_FLAG_SECTOR",32:"ELEM_MODE_9_NAME_SECTOR",
    33:"ELEM_MODE_9_DESC_SECTOR",34:"ELEM_MODE_9_FLAG_SECTOR",35:"ELEM_MODE_10_NAME_SECTOR",36:"ELEM_MODE_10_DESC_SECTOR",
    37:"ELEM_MODE_10_FLAG_SECTOR",38:"ELEM_MODE_11_NAME_SECTOR",39:"ELEM_MODE_11_DESC_SECTOR",40:"ELEM_MODE_11_FLAG_SECTOR",
    41:"ELEM_MODE_12_NAME_SECTOR",42:"ELEM_MODE_12_DESC_SECTOR",43:"ELEM_MODE_12_FLAG_SECTOR",44:"ELEM_MODE_13_NAME_SECTOR",
    45:"ELEM_MODE_13_DESC_SECTOR",46:"ELEM_MODE_13_FLAG_SECTOR",47:"ELEM_MODE_14_NAME_SECTOR",48:"ELEM_MODE_14_DESC_SECTOR",
    49:"ELEM_MODE_14_FLAG_SECTOR",50:"ELEM_MODE_15_NAME_SECTOR",51:"ELEM_MODE_15_DESC_SECTOR",52:"ELEM_MODE_15_FLAG_SECTOR",
    53:"ELEM_ICON_ROW_0_SECTOR",54:"ELEM_ICON_ROW_1_SECTOR",63:"ELEM_ICON_ROW_10_SECTOR",95:"ELEM_WHATEVER_SECTOR",
    115:"ELEM_CURRENT_XMANAGER_SECTOR"
  };
  
  const commandsMap = {
    0:"BLACKOUT",1:"START_CMD",2:"TEST_CMD",3:"SEND_REG_RF_CMD",4:"SEND_STATS_RF_CMD",
    5:"ERR_DBG_ON",6:"ERR_DBG_OFF",7:"SET_ELEM_DEAF",8:"SET_ELEM_LONG_DEAF",9:"MAGIC_TEST_CMD",
    10:"MAGIC_TEST_2_CMD",11:"ALTERNATE_MODE_ON",12:"ALTERNATE_MODE_OFF",13:"OTA_AP_ON",14:"OTA_AP_OFF"
  };
  
  // Inicialización de la aplicación
  function inicializarApp() {
    actualizarVistaDatos();
    cargarHistorial();
    cargarConfiguraciones();
    actualizarEstructuraTrama();
    
    // Verificar si hay un tema guardado
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      document.body.classList.add('light-theme');
      document.querySelector('.theme-toggle i').classList.remove('fa-moon');
      document.querySelector('.theme-toggle i').classList.add('fa-sun');
    }
    
    // Agregar event listeners para actualizar la estructura de la trama
    document.getElementById('destinoManual').addEventListener('input', actualizarEstructuraTrama);
    document.getElementById('origenCustom').addEventListener('input', actualizarEstructuraTrama);
    document.getElementById('data').addEventListener('input', actualizarEstructuraTrama);
  }
  
  // Cambio de tema
  function toggleTheme() {
    const body = document.body;
    const icon = document.querySelector('.theme-toggle i');
    
    body.classList.toggle('light-theme');
    
    if (body.classList.contains('light-theme')) {
      icon.classList.remove('fa-moon');
      icon.classList.add('fa-sun');
      localStorage.setItem('theme', 'light');
    } else {
      icon.classList.remove('fa-sun');
      icon.classList.add('fa-moon');
      localStorage.setItem('theme', 'dark');
    }
  }
  
  // Historial
  function toggleHistory() {
    document.getElementById('historyPanel').classList.toggle('open');
  }
  
  function cargarHistorial() {
    const historial = JSON.parse(localStorage.getItem('tramaHistory') || '[]');
    const container = document.getElementById('historyItems');
    container.innerHTML = '';
    
    if (historial.length === 0) {
      container.innerHTML = '<p>No hay tramas guardadas en el historial</p>';
      return;
    }
    
    historial.forEach((item, index) => {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      historyItem.innerHTML = `
        <div class="history-item-title">${item.title || `Trama ${index + 1}`}</div>
        <div class="history-item-content">${item.trama}</div>
      `;
      historyItem.addEventListener('click', () => {
        document.getElementById('inputTrama').value = item.trama;
        decodificarTrama();
        toggleHistory();
      });
      container.appendChild(historyItem);
    });
  }
  
  function guardarEnHistorial() {
    const trama = document.getElementById('tramaHex').textContent;
    if (!trama) return;
    
    const title = prompt('Ingrese un nombre para esta trama:', 'Trama ' + (new Date()).toLocaleString());
    if (title === null) return; // El usuario canceló
    
    const historial = JSON.parse(localStorage.getItem('tramaHistory') || '[]');
    historial.unshift({ title, trama });
    
    // Limitar a 20 entradas
    if (historial.length > 20) {
      historial.pop();
    }
    
    localStorage.setItem('tramaHistory', JSON.stringify(historial));
    cargarHistorial();
    
    // Mostrar toast
    const toast = document.createElement("div");
    toast.className = "copy-toast";
    toast.innerHTML = '<i class="fas fa-check-circle"></i> Trama guardada en el historial';
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.remove();
    }, 2000);
  }
  
  function clearHistory() {
    if (confirm('¿Está seguro de que desea borrar todo el historial?')) {
      localStorage.removeItem('tramaHistory');
      cargarHistorial();
    }
  }
  
  // Configuraciones guardadas
  function saveCurrentConfig() {
    const configName = document.getElementById('configName').value.trim();
    if (!configName) {
      alert('Por favor ingrese un nombre para la configuración');
      return;
    }
    
    // Recopilar todos los valores del formulario
    const config = {
      origen: document.getElementById('origen').value,
      origenCustom: document.getElementById('origenCustom').value,
      destino: document.getElementById('destino').value,
      destinoManual: document.getElementById('destinoManual').value,
      function: document.getElementById('function').value,
      // Valores específicos según la función
      color: document.getElementById('color').value,
      rVal: document.getElementById('rVal').value,
      gVal: document.getElementById('gVal').value,
      bVal: document.getElementById('bVal').value,
      flag: document.getElementById('flag').value,
      minVal: document.getElementById('minVal').value,
      maxVal: document.getElementById('maxVal').value,
      valVal: document.getElementById('valVal').value,
      sector: document.getElementById('sector').value,
      idioma: document.getElementById('idioma').value,
      commandSel: document.getElementById('commandSel').value,
      elemId: document.getElementById('elemId').value,
      elemMode: document.getElementById('elemMode').value,
      elemDeaf: document.getElementById('elemDeaf').value,
      fileBank: document.getElementById('fileBank').value,
      fileNum: document.getElementById('fileNum').value,
      patternNum: document.getElementById('patternNum').value,
      data: document.getElementById('data').value
    };
    
    // Guardar en localStorage
    let configs = JSON.parse(localStorage.getItem('savedConfigs') || '{}');
    configs[configName] = config;
    localStorage.setItem('savedConfigs', JSON.stringify(configs));
    
    // Actualizar la lista
    cargarConfiguraciones();
    
    // Limpiar el campo de nombre
    document.getElementById('configName').value = '';
    
    // Mostrar toast
    const toast = document.createElement("div");
    toast.className = "copy-toast";
    toast.innerHTML = '<i class="fas fa-check-circle"></i> Configuración guardada';
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.remove();
    }, 2000);
  }
  
  function cargarConfiguraciones() {
    const configs = JSON.parse(localStorage.getItem('savedConfigs') || '{}');
    const container = document.getElementById('savedConfigs');
    container.innerHTML = '';
    
    if (Object.keys(configs).length === 0) {
      container.innerHTML = '<p>No hay configuraciones guardadas</p>';
      return;
    }
    
    for (const [name, config] of Object.entries(configs)) {
      const configItem = document.createElement('div');
      configItem.className = 'config-item';
      configItem.innerHTML = `
        <div class="config-name">${name}</div>
        <div class="config-actions">
          <span class="config-action load" title="Cargar configuración" onclick="loadConfig('${name}')"><i class="fas fa-upload"></i></span>
          <span class="config-action delete" title="Eliminar configuración" onclick="deleteConfig('${name}')"><i class="fas fa-trash"></i></span>
        </div>
      `;
      container.appendChild(configItem);
    }
  }
  
  function loadConfig(name) {
    const configs = JSON.parse(localStorage.getItem('savedConfigs') || '{}');
    const config = configs[name];
    if (!config) return;
    
    // Cargar todos los valores al formulario
    document.getElementById('origen').value = config.origen;
    document.getElementById('origenCustom').value = config.origenCustom;
    toggleOrigenInput(); // Actualizar visibilidad del campo personalizado
    
    document.getElementById('destino').value = config.destino;
    document.getElementById('destinoManual').value = config.destinoManual || '';
    toggleDestinoInput(); // Actualizar visibilidad del campo personalizado
    
    document.getElementById('function').value = config.function;
    
    // Actualizar la vista según la función
    actualizarVistaDatos();
    
    // Cargar valores específicos según la función
    document.getElementById('color').value = config.color;
    
    document.getElementById('rVal').value = config.rVal;
    document.getElementById('gVal').value = config.gVal;
    document.getElementById('bVal').value = config.bVal;
    document.getElementById('flag').value = config.flag;
    document.getElementById('minVal').value = config.minVal;
    document.getElementById('maxVal').value = config.maxVal;
    document.getElementById('valVal').value = config.valVal;
    document.getElementById('sector').value = config.sector;
    document.getElementById('idioma').value = config.idioma;
    document.getElementById('commandSel').value = config.commandSel;
    document.getElementById('elemId').value = config.elemId;
    document.getElementById('elemMode').value = config.elemMode;
    document.getElementById('elemDeaf').value = config.elemDeaf;
    document.getElementById('fileBank').value = config.fileBank;
    document.getElementById('fileNum').value = config.fileNum;
    document.getElementById('patternNum').value = config.patternNum;
    document.getElementById('data').value = config.data;
    
    // Actualizar la vista del color si es necesario
    updatePreview();
    
    // Actualizar la estructura de la trama
    actualizarEstructuraTrama();
    
    // Mostrar toast
    const toast = document.createElement("div");
    toast.className = "copy-toast";
    toast.innerHTML = '<i class="fas fa-check-circle"></i> Configuración cargada';
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.remove();
    }, 2000);
  }
  
  function deleteConfig(name) {
    if (confirm(`¿Está seguro de que desea eliminar la configuración "${name}"?`)) {
      let configs = JSON.parse(localStorage.getItem('savedConfigs') || '{}');
      delete configs[name];
      localStorage.setItem('savedConfigs', JSON.stringify(configs));
      cargarConfiguraciones();
    }
  }
  
  // Validación de campos
  function validateHexOrDecimal(input, min, max) {
    const value = parseColorValue(input.value);
    const errorId = input.id + 'Error';
    const errorElement = document.getElementById(errorId);
    
    if (isNaN(value) || value < min || value > max) {
      input.classList.add('validation-error');
      errorElement.style.display = 'block';
      errorElement.textContent = `Valor debe estar entre ${min} y ${max}`;
      return false;
    } else {
      input.classList.remove('validation-error');
      errorElement.style.display = 'none';
      return true;
    }
  }
  
  function validateNumber(input) {
    const value = parseInt(input.value);
    const errorId = input.id + 'Error';
    const errorElement = document.getElementById(errorId);
    
    if (isNaN(value)) {
      input.classList.add('validation-error');
      errorElement.style.display = 'block';
      return false;
    } else {
      input.classList.remove('validation-error');
      errorElement.style.display = 'none';
      return true;
    }
  }
  
  function validateHexInput(input) {
    const value = input.value.trim();
    const hexPattern = /^(0x)?[0-9A-Fa-f]+$/;
    const errorId = input.id + 'Error';
    const errorElement = document.getElementById(errorId);
    
    if (!hexPattern.test(value)) {
      input.classList.add('validation-error');
      errorElement.style.display = 'block';
      return false;
    } else {
      input.classList.remove('validation-error');
      errorElement.style.display = 'none';
      return true;
    }
  }
  
  function validateDestinos() {
    const destinoSelect = document.getElementById('destino').value;
    
    if (destinoSelect === 'manual') {
      const destinos = document.getElementById('destinoManual').value.trim();
      const errorElement = document.getElementById('destinoError');
      
      if (!destinos) {
        document.getElementById('destinoManual').classList.add('validation-error');
        errorElement.style.display = 'block';
        return false;
      }
      
      const hexPattern = /^(0x)?[0-9A-Fa-f]+$/;
      const destinosArray = destinos.split(' ');
      
      for (const destino of destinosArray) {
        if (!hexPattern.test(destino)) {
          document.getElementById('destinoManual').classList.add('validation-error');
          errorElement.style.display = 'block';
          return false;
        }
      }
      
      document.getElementById('destinoManual').classList.remove('validation-error');
      errorElement.style.display = 'none';
      return true;
    }
    
    return true; // Si no es manual, es una opción válida
  }
  
  // Función para mostrar/ocultar campos de destino según la selección
  function toggleDestinoInput() {
    const destinoSelect = document.getElementById('destino').value;
    document.getElementById('destinoManual').classList.toggle('hidden', destinoSelect !== 'manual');
    actualizarEstructuraTrama();
  }
  
  // Actualizar la estructura visual de la trama
  function actualizarEstructuraTrama() {
    const func = document.getElementById("function").value;
    const origen = (document.getElementById("origen").value === "custom")
      ? document.getElementById("origenCustom").value || "DB"
      : document.getElementById("origen").value;
    
    // Obtener destinos según la selección
    let destinos = [];
    const destinoSelect = document.getElementById("destino").value;
    if (destinoSelect === 'manual') {
      const destinosStr = document.getElementById("destinoManual").value.trim();
      if (destinosStr) {
        destinos = destinosStr.split(" ").map(d => d.replace(/^0x/i, ''));
      } else {
        destinos = ["DD"];
      }
    } else {
      destinos = [destinoSelect];
    }
    
    // Calcular longitud de datos según la función
    let datosLength = 0;
    let datos = [];
    
    // Determinar datos según la función
    if (func === "C1") {
      datosLength = 1;
      datos = [{ value: document.getElementById("color").value || "00", tooltip: "Color" }];
    } else if (func === "C2") {
      datosLength = 3;
      const r = parseColorValue(document.getElementById("rVal").value) || 0;
      const g = parseColorValue(document.getElementById("gVal").value) || 0;
      const b = parseColorValue(document.getElementById("bVal").value) || 0;
      datos = [
        { value: r.toString(16).padStart(2, '0').toUpperCase(), tooltip: "R" },
        { value: g.toString(16).padStart(2, '0').toUpperCase(), tooltip: "G" },
        { value: b.toString(16).padStart(2, '0').toUpperCase(), tooltip: "B" }
      ];
    } else if (func === "CE") {
      datosLength = 1;
      datos = [{ value: document.getElementById("flag").value || "00", tooltip: "Estado" }];
    } else if (func === "A0") {
      datosLength = 2;
      datos = [
        { value: document.getElementById("idioma").value || "01", tooltip: "Idioma" },
        { value: document.getElementById("sector").value || "00", tooltip: "Sector" }
      ];
    } else if (func === "B1") {
      datosLength = 1;
      datos = [{ value: document.getElementById("elemId").value || "00", tooltip: "ID Elemento" }];
    } else if (func === "B2") {
      datosLength = 1;
      datos = [{ value: document.getElementById("elemMode").value || "00", tooltip: "Modo Elemento" }];
    } else if (func === "B3") {
      datosLength = 1;
      datos = [{ value: document.getElementById("elemDeaf").value || "00", tooltip: "Tiempo Ensordecer" }];
    } else if (func === "CC") {
      datosLength = 2;
      datos = [
        { value: document.getElementById("fileBank").value || "00", tooltip: "Bank" },
        { value: document.getElementById("fileNum").value || "00", tooltip: "File" }
      ];
    } else if (func === "CD") {
      datosLength = 1;
      datos = [{ value: document.getElementById("patternNum").value || "00", tooltip: "Patrón" }];
    } else {
      const rawData = document.getElementById("data").value.trim();
      if (rawData) {
        const dataArray = rawData.split(" ").map(d => d.replace(/^0x/i, ''));
        datosLength = dataArray.length;
        datos = dataArray.map(d => ({ value: d, tooltip: "Datos" }));
      } else {
        datosLength = 0;
        datos = [];
      }
    }
    
    // Calcular la longitud total del frame
    const frameLen = 7 + destinos.length + datosLength;
    const msbLen = (frameLen >> 8) & 0xFF;
    const lsbLen = frameLen & 0xFF;
    
    // Construir la estructura básica
    let estructura = [
      { value: "E1", tooltip: "Inicio de trama" },
      { value: msbLen.toString(16).padStart(2, '0').toUpperCase(), tooltip: "Longitud (MSB)" },
      { value: lsbLen.toString(16).padStart(2, '0').toUpperCase(), tooltip: "Longitud (LSB)" },
      { value: origen, tooltip: "Origen" },
      { value: destinos.length.toString(16).padStart(2, '0').toUpperCase(), tooltip: "Número de destinos" }
    ];
    
    // Agregar destinos
    destinos.forEach(destino => {
      estructura.push({ value: destino.replace(/^0x/i, ''), tooltip: "Destino" });
    });
    
    // Agregar función
    estructura.push({ value: func, tooltip: "Función" });
    
    // Agregar longitud de datos
    estructura.push({ value: "00", tooltip: "Longitud datos (MSB)" });
    estructura.push({ value: datosLength.toString(16).padStart(2, '0').toUpperCase(), tooltip: "Longitud datos (LSB)" });
    
    // Agregar datos
    estructura = estructura.concat(datos);
    
    // Agregar checksum y fin de trama
    estructura.push({ value: "XX", tooltip: "Checksum" });
    estructura.push({ value: "BB", tooltip: "Fin de trama" });
    
    // Actualizar el DOM
    const container = document.getElementById('frameStructure');
    container.innerHTML = '';
    
    estructura.forEach(byte => {
      const byteElement = document.createElement('div');
      byteElement.className = 'frame-byte';
      byteElement.innerHTML = `0x${byte.value}<div class="byte-tooltip">${byte.tooltip}</div>`;
      container.appendChild(byteElement);
    });
  }
  
  function toggleOrigenInput() {
    document.getElementById("origenCustom").classList.toggle("hidden", document.getElementById("origen").value !== "custom");
    actualizarEstructuraTrama();
  }
  
  function hexToByteArray(str) {
    return str.trim().split(" ").filter(x => x).map(h => parseInt(h.replace(/^0x/i, ""), 16));
  }
  
  function actualizarVistaDatos() {
    const func = document.getElementById("function").value;
    // Ocultar todos los paneles especializados
    ["sectorSelector","idiomaSelector","colorSelector","rgbSelector",
     "flagSelector","sensorSelector","commandSelector","elemIdSelector","elemModeSelector",
     "elemDeafSelector","fileNumSelector","patternNumSelector","dataInput"]
     .forEach(id => document.getElementById(id).classList.add("hidden"));
  
    if(func==="A0") {
      document.getElementById("sectorSelector").classList.remove("hidden");
      document.getElementById("idiomaSelector").classList.remove("hidden");
    }
    if(func==="C1") document.getElementById("colorSelector").classList.remove("hidden");
    if(func==="C2") document.getElementById("rgbSelector").classList.remove("hidden");
    if(func==="CE") document.getElementById("flagSelector").classList.remove("hidden");
    if(func==="CA") document.getElementById("sensorSelector").classList.remove("hidden");
    if(func==="CF") document.getElementById("commandSelector").classList.remove("hidden");
    if(func==="B1") document.getElementById("elemIdSelector").classList.remove("hidden");
    if(func==="B2") document.getElementById("elemModeSelector").classList.remove("hidden");
    if(func==="B3") document.getElementById("elemDeafSelector").classList.remove("hidden");
    if(func==="CC") document.getElementById("fileNumSelector").classList.remove("hidden");
    if(func==="CD") document.getElementById("patternNumSelector").classList.remove("hidden");
    // Si la función no es ninguna de las especializadas, mostrar el campo de datos
    if(!["A0","C1","C2","CE","CA","CF","B1","B2","B3","CC","CD"].includes(func)) {
      document.getElementById("dataInput").classList.remove("hidden");
    }
  
    // Rellenar opciones de color y sector si aún no se han creado
    const colorSel = document.getElementById("color");
    if (colorSel.children.length === 0) {
      Object.entries(colorMap).forEach(([val, name]) => {
        let opt = document.createElement("option");
        opt.value = val;
        opt.textContent = name;
        colorSel.appendChild(opt);
      });
    }
  
    const sectorSel = document.getElementById("sector");
    sectorSel.innerHTML = "";
    Object.entries(sectorList).forEach(([k,v]) => {
      let opt = document.createElement("option");
      opt.value = k;
      opt.textContent = `${k} - ${v}`;
      sectorSel.appendChild(opt);
    });
  
    const cmdSel = document.getElementById("commandSel");
    if (cmdSel.children.length === 0) {
      Object.entries(commandsMap).forEach(([val,name])=>{
        let opt = document.createElement("option");
        opt.value = val;
        opt.textContent = name;
        cmdSel.appendChild(opt);
      });
    }
  
    document.getElementById("rgbPicker").addEventListener("input", e => {
      const c = e.target.value;
      document.getElementById("rVal").value = parseInt(c.substr(1,2),16);
      document.getElementById("gVal").value = parseInt(c.substr(3,2),16);
      document.getElementById("bVal").value = parseInt(c.substr(5,2),16);
      updatePreview();
    });
  
    document.querySelectorAll("#rVal,#gVal,#bVal").forEach(el=>el.addEventListener("input",updatePreview));
    
    // Actualizar la estructura visual de la trama
    actualizarEstructuraTrama();
  }
  
  function updatePreview() {
    const r = parseColorValue(document.getElementById("rVal").value) || 0,
          g = parseColorValue(document.getElementById("gVal").value) || 0,
          b = parseColorValue(document.getElementById("bVal").value) || 0;
    const preview = document.getElementById("colorPreview");
    if(preview) {
      preview.style.backgroundColor = `rgb(${r},${g},${b})`;
      document.getElementById("rgbValue").textContent = `RGB(${r}, ${g}, ${b})`;
    }
    
    // Actualizar la estructura visual de la trama
    actualizarEstructuraTrama();
  }
  
  function limpiarFormulario() {
    // Restablecer valores por defecto
    document.getElementById("origen").value = "DB";
    document.getElementById("origenCustom").value = "";
    document.getElementById("destino").value = "DD";
    document.getElementById("destinoManual").value = "";
    document.getElementById("function").value = "C1";
    document.getElementById("color").value = "0";
    document.getElementById("rVal").value = "";
    document.getElementById("gVal").value = "";
    document.getElementById("bVal").value = "";
    document.getElementById("flag").value = "01";
    document.getElementById("minVal").value = "";
    document.getElementById("maxVal").value = "";
    document.getElementById("valVal").value = "";
    document.getElementById("sector").value = "0";
    document.getElementById("idioma").value = "1";
    document.getElementById("commandSel").value = "0";
    document.getElementById("elemId").value = "";
    document.getElementById("elemMode").value = "";
    document.getElementById("elemDeaf").value = "";
    document.getElementById("fileBank").value = "";
    document.getElementById("fileNum").value = "";
    document.getElementById("patternNum").value = "";
    document.getElementById("data").value = "";
    document.getElementById("tramaHex").textContent = "";
    document.getElementById("resultado").innerHTML = "";
    
    // Ocultar mensajes de error
    document.querySelectorAll(".error-message").forEach(el => el.style.display = "none");
    document.querySelectorAll("input").forEach(el => el.classList.remove("validation-error"));
    
    // Actualizar la vista
    actualizarVistaDatos();
    toggleOrigenInput();
    toggleDestinoInput();
  }
  
  function generarTrama() {
    // Validar campos
    let isValid = true;
    
    // Validar origen personalizado si está seleccionado
    if (document.getElementById("origen").value === "custom") {
      isValid = validateHexOrDecimal(document.getElementById("origenCustom"), 0, 255) && isValid;
    }
    
    // Validar destinos
    isValid = validateDestinos() && isValid;
    
    // Validar campos específicos según la función
    const func = document.getElementById("function").value;
    
    if (func === "C2") {
      isValid = validateHexOrDecimal(document.getElementById("rVal"), 0, 255) && isValid;
      isValid = validateHexOrDecimal(document.getElementById("gVal"), 0, 255) && isValid;
      isValid = validateHexOrDecimal(document.getElementById("bVal"), 0, 255) && isValid;
    } else if (func === "CA") {
      isValid = validateNumber(document.getElementById("minVal")) && isValid;
      isValid = validateNumber(document.getElementById("maxVal")) && isValid;
      isValid = validateNumber(document.getElementById("valVal")) && isValid;
    } else if (func === "B1") {
      isValid = validateHexOrDecimal(document.getElementById("elemId"), 0, 255) && isValid;
    } else if (func === "B2") {
      isValid = validateHexOrDecimal(document.getElementById("elemMode"), 0, 15) && isValid;
    } else if (func === "B3") {
      isValid = validateHexOrDecimal(document.getElementById("elemDeaf"), 0, 255) && isValid;
    } else if (func === "CC") {
      isValid = validateHexOrDecimal(document.getElementById("fileBank"), 0, 255) && isValid;
      isValid = validateHexOrDecimal(document.getElementById("fileNum"), 0, 255) && isValid;
    } else if (func === "CD") {
      isValid = validateHexOrDecimal(document.getElementById("patternNum"), 0, 255) && isValid;
    }
    
    if (!isValid) {
      // Mostrar mensaje de error
      const toast = document.createElement("div");
      toast.className = "copy-toast";
      toast.style.backgroundColor = "var(--danger-color)";
      toast.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Por favor corrija los errores en el formulario';
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 2000);
      return;
    }
    
    const origen = (document.getElementById("origen").value === "custom")
      ? parseInt(document.getElementById("origenCustom").value,16)
      : parseInt(document.getElementById("origen").value,16);
    
    // Obtener destinos según la selección
    let targets = [];
    const destinoSelect = document.getElementById("destino").value;
    if (destinoSelect === 'manual') {
      const destinosStr = document.getElementById("destinoManual").value.trim();
      if (destinosStr) {
        targets = destinosStr.split(" ").map(d => parseInt(d.replace(/^0x/i, ""),16));
      } else {
        targets = [0xDD];
      }
    } else {
      targets = [parseInt(destinoSelect,16)];
    }
    
    let data = [];
    // Seleccionar los datos según la función:
    if(func==="A0") {
      data = [parseInt(idioma.value), parseInt(sector.value)];
    } else if(func==="C1") {
      data = [parseInt(color.value)];
    } else if(func==="C2") {
      let r = parseColorValue(document.getElementById("rVal").value) || 0,
          g = parseColorValue(document.getElementById("gVal").value) || 0,
          b = parseColorValue(document.getElementById("bVal").value) || 0;
      data = [r, g, b];
    } else if(func==="CE") {
      data = [parseInt(flag.value,16)];
    } else if(func==="CA") {
      let min = parseInt(minVal.value) || 0, 
          max = parseInt(maxVal.value) || 0, 
          val = parseInt(valVal.value) || 0;
      data = [min >> 8, min & 0xFF, max >> 8, max & 0xFF, val >> 8, val & 0xFF];
    } else if(func==="CF") {
      const cmdVal = parseInt(document.getElementById("commandSel").value);
      data = [cmdVal];
    } else if(func==="B1") {
      // F_SET_ELEM_ID
      data = [parseColorValue(document.getElementById("elemId").value)];
    } else if(func==="B2") {
      // F_SET_ELEM_MODE
      data = [parseInt(document.getElementById("elemMode").value, 16)];
    } else if(func==="B3") {
      // F_SET_ELEM_DEAF
      data = [parseInt(document.getElementById("elemDeaf").value, 16)];
    } else if(func==="CC") {
      // F_SEND_FILE_NUM
      data = [
        parseInt(document.getElementById("fileBank").value, 16),
        parseInt(document.getElementById("fileNum").value, 16)
      ];
    } else if(func==="CD") {
      // F_SEND_PATTERN_NUM
      data = [parseInt(document.getElementById("patternNum").value, 16)];
    } else {
      const raw = document.getElementById("data").value.trim();
      data = raw ? hexToByteArray(raw) : [];
    }
    // Cálculo del frameLength: según la fórmula definida:
    // frameLength = 0x07 + (número de destinos) + (longitud de la función)
    // La longitud de la función se deduce del número de bytes en data
    const frameLen = 7 + targets.length + data.length;
    const frame = [
      0xE1,
      (frameLen >> 8), (frameLen & 0xFF),
      origen,
      targets.length,
      ...targets,
      parseInt(func,16),
      (data.length >> 8) & 0xFF, (data.length & 0xFF),
      ...data
    ];
    // El checksum se calcula sumando todos los bytes del frame concatenado con 0xBB
    function computeChecksum(bytes) {
       let sum = 0;
       for(let b of bytes) {
         sum += b;
         while(sum > 0xFF) {
           sum = (sum & 0xFF) + (sum >> 8);
         }
       }
       return sum;
    }
    const checksum = computeChecksum(frame.concat(0xBB));
    const trama = [...frame, checksum, 0xBB];
    document.getElementById("tramaHex").textContent = trama.map(
      b => ("0x" + b.toString(16).padStart(2,"0").toUpperCase())
    ).join(" ");
    document.getElementById("tramaHex").classList.add("fade-in");
    setTimeout(() => {
      document.getElementById("tramaHex").classList.remove("fade-in");
    }, 300);
    
    // Actualizar la estructura visual de la trama
    actualizarEstructuraTrama();
    
    // Automáticamente decodificar la trama generada
    document.getElementById("inputTrama").value = document.getElementById("tramaHex").textContent;
    decodificarTrama();
  }
  
  function copiarTrama(){
    navigator.clipboard.writeText(document.getElementById("tramaHex").textContent)
      .then(() => {
        const btn = document.getElementById("copyBtn");
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
        const toast = document.createElement("div");
        toast.className = "copy-toast";
        toast.innerHTML = '<i class="fas fa-check-circle"></i> Trama copiada al portapapeles';
        document.body.appendChild(toast);
        setTimeout(() => {
          btn.innerHTML = originalText;
          toast.remove();
        }, 2000);
      })
      .catch(err => {
        console.error('Error al copiar: ', err);
      });
  }
  
  function decodificarTrama() {
    const inputValue = document.getElementById("inputTrama").value.trim();
    if (!inputValue) {
      document.getElementById("resultado").innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Por favor ingrese una trama para decodificar</span>';
      return;
    }
    const arr = inputValue.split(" ").map(h => parseInt(h.replace("0x",""), 16));
    if(arr.includes(NaN)) {
      document.getElementById("resultado").innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Formato de trama inválido</span>';
      return;
    }
    // El campo de longitud en la trama es el valor almacenado en los bytes 1 y 2,
    // y la longitud total esperada es ese valor + 3
    let expectedFrameLength = (arr[1] << 8) | arr[2];
    let totalFrameLength = expectedFrameLength + 3;
    if(arr.length !== totalFrameLength) {
      document.getElementById("resultado").innerHTML = `<span style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Trama inválida: Longitud incorrecta (esperada ${totalFrameLength} bytes, recibidos ${arr.length} bytes)</span>`;
      return;
    }
    // Validación de inicio y fin de trama
    if(arr[0] !== 0xE1) {
      document.getElementById("resultado").innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Trama inválida: No comienza con 0xE1</span>';
      return;
    }
    if(arr[arr.length - 1] !== 0xBB) {
      document.getElementById("resultado").innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Trama inválida: No termina con 0xBB</span>';
      return;
    }
    // Cálculo del checksum: se suman los bytes desde el índice 0 hasta arr.length-3 y se agrega 0xBB
    function computeChecksum(bytes) {
       let sum = 0;
       for(let b of bytes) {
         sum += b;
         while(sum > 0xFF) {
           sum = (sum & 0xFF) + (sum >> 8);
         }
       }
       return sum;
    }
    let dataToSum = arr.slice(0, arr.length - 2);
    let computedChecksum = computeChecksum(dataToSum.concat(0xBB));
    let receivedChecksum = arr[arr.length - 2];
    let checksumValid = (computedChecksum === receivedChecksum);
    
    let out = "";
    if(checksumValid) {
       out += `<div style="color: var(--success-color); font-weight: bold; margin-bottom: 10px;"><i class="fas fa-check-circle"></i> Trama VÁLIDA</div>`;
    } else {
       out += `<div style="color: var(--danger-color); font-weight: bold; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Trama INVÁLIDA</div>`;
    }
    
    const origin = arr[3];
    const numT = arr[4];
    const targets = arr.slice(5, 5+numT);
    const func = arr[5+numT];
    const dataLen = ((arr[6+numT] << 8) | arr[7+numT]);
    const dataStart = 8+numT;
    const data = arr.slice(dataStart, dataStart+dataLen);
    
    // Obtener nombre del dispositivo de origen
    const originHex = origin.toString(16).toUpperCase().padStart(2,'0');
    const originName = deviceMap[originHex] || "";
    const originDisplay = originName ? `0x${originHex} (${originName})` : `0x${originHex}`;
    
    out += `<div class="decoded-item"><span class="icon"><i class="fas fa-broadcast-tower"></i></span> <span class="label">Origen:</span> <span class="value">${originDisplay}</span></div>`;
    
    // Mostrar destinos con nombres si están disponibles
    out += `<div class="decoded-item"><span class="icon"><i class="fas fa-laptop-code"></i></span> <span class="label">Destinos:</span> <span class="value">`;
    targets.forEach((t, index) => {
      const targetHex = t.toString(16).toUpperCase().padStart(2,'0');
      const targetName = deviceMap[targetHex] || "";
      const targetDisplay = targetName ? `0x${targetHex} (${targetName})` : `0x${targetHex}`;
      out += targetDisplay;
      if (index < targets.length - 1) out += ", ";
    });
    out += `</span></div>`;
    
    // Mostrar función con nombre
    const funcHex = func.toString(16).toUpperCase().padStart(2,'0');
    const funcName = functionMap[funcHex] || "";
    const funcDisplay = funcName ? `0x${funcHex} (${funcName})` : `0x${funcHex}`;
    
    out += `<div class="decoded-item"><span class="icon"><i class="fas fa-cogs"></i></span> <span class="label">Función:</span> <span class="value">${funcDisplay}</span></div>`;
    
    if(func === 0xC1) {
      const colorName = colorMap[data[0]] || "Desconocido";
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-palette"></i></span> <span class="label">Color:</span> <span class="value">${colorName}</span></div>`;
    }
    else if(func === 0xC2) {
      const r = data[0] || 0, g = data[1] || 0, b = data[2] || 0;
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-circle" style="color: red;"></i></span> <span class="label">R:</span> <span class="value">${r}</span></div>`;
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-circle" style="color: green;"></i></span> <span class="label">G:</span> <span class="value">${g}</span></div>`;
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-circle" style="color: blue;"></i></span> <span class="label">B:</span> <span class="value">${b}</span></div>`;
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-square"></i></span> <span class="label">Color:</span> <span class="value"><div style="width:50px;height:20px;background: rgb(${r},${g},${b}); border-radius:3px;"></div></span></div>`;
    }
    else if(func === 0xCE) {
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-toggle-${data[0]===1 ? "on" : "off"}"></i></span> <span class="label">Estado:</span> <span class="value">${data[0]===1 ? "ON" : "OFF"}</span></div>`;
    }
    else if(func === 0xA0) {
      const idiomaName = idiomaMap[data[0]] || data[0];
      const sectorName = sectorList[data[1]] || data[1];
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-language"></i></span> <span class="label">Idioma:</span> <span class="value">${idiomaName}</span></div>`;
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-folder-open"></i></span> <span class="label">Sector:</span> <span class="value">${sectorName}</span></div>`;
    }
    else if(func === 0xCA) {
      const min = (data[0]<<8)|data[1], max = (data[2]<<8)|data[3], val = (data[4]<<8)|data[5];
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-temperature-low"></i></span> <span class="label">MIN:</span> <span class="value">${min}</span></div>`;
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-temperature-high"></i></span> <span class="label">MAX:</span> <span class="value">${max}</span></div>`;
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-thermometer-half"></i></span> <span class="label">VAL:</span> <span class="value">${val}</span></div>`;
    }
    else if(func === 0xB1) {
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-id-card"></i></span> <span class="label">ID:</span> <span class="value">${data[0]}</span></div>`;
    }
    else if(func === 0xB2) {
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-sliders-h"></i></span> <span class="label">Modo:</span> <span class="value">0x${data[0].toString(16).toUpperCase().padStart(2,'0')}</span></div>`;
    }
    else if(func === 0xB3) {
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-volume-mute"></i></span> <span class="label">Ensordecer:</span> <span class="value">0x${data[0].toString(16).toUpperCase().padStart(2,'0')}</span></div>`;
    }
    else if(func === 0xCC) {
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-file-alt"></i></span> <span class="label">Bank:</span> <span class="value">0x${data[0].toString(16).toUpperCase().padStart(2,'0')}</span></div>`;
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-hashtag"></i></span> <span class="label">File:</span> <span class="value">0x${data[1].toString(16).toUpperCase().padStart(2,'0')}</span></div>`;
    }
    else if(func === 0xCD) {
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-th"></i></span> <span class="label">Patrón:</span> <span class="value">0x${data[0].toString(16).toUpperCase().padStart(2,'0')}</span></div>`;
    }
    else {
      out += `<div class="decoded-item"><span class="icon"><i class="fas fa-cubes"></i></span> <span class="label">Data:</span> <span class="value">${data.map(b=>"0x"+b.toString(16).toUpperCase().padStart(2,'0')).join(" ")}</span></div>`;
    }
    
    out += `<div class="decoded-item checksum ${checksumValid ? "valid" : "invalid"}">
              <span class="icon"><i class="fas fa-${checksumValid ? "check-circle" : "exclamation-triangle"}"></i></span> 
              <span class="label">Checksum:</span> 
              <span class="value">Recibido: 0x${receivedChecksum.toString(16).toUpperCase().padStart(2,'0')} / Calculado: 0x${computedChecksum.toString(16).toUpperCase().padStart(2,'0')}</span>
            </div>`;
    
    document.getElementById("resultado").innerHTML = out;
    document.getElementById("resultado").classList.add("fade-in");
    setTimeout(() => {
      document.getElementById("resultado").classList.remove("fade-in");
    }, 300);
  }
  
  document.getElementById("inputTrama").addEventListener("keyup", function(event) {
    if (event.key === "Enter") {
      decodificarTrama();
    }
  });
</script>
</body>
</html>
